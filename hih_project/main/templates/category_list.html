{% extends 'base.html' %}
{% load static %}

{% block title %}
–í—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ - HiH Store
{% endblock %}

{% block content %}
<div class="category_list_page">
    
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <br><br>   <br><br>   <br><br>  

    <!-- –§–æ—Ä–º–∞ –≤—ã–±–æ—Ä–∞ -->
    <div class="category_list_form_section">
<form method="get" action="{% url 'app_for_category' %}" class="category_list_form" id="categoryForm">
            <!-- –ì–ª–∞–≤–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
            <div class="category_list_form_group">
                <h2 class="category_list_form_label">–®–∞–≥ 1: –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h2>
                <div class="category_list_buttons_grid" id="categoriesGrid">
                    {% for category in categories %}
                    <div class="category_list_card category_list_category_card" 
                         data-category-id="{{ category.id }}"
                         data-category-name="{{ category.name }}">
                        <div class="category_list_button_icon">
                            {% if category.icon %}
                                <img src="{{ category.icon.url }}" alt="{{ category.name }}">
                            {% else %}
                                <div class="category_list_icon_placeholder">üéÆ</div>
                            {% endif %}
                        </div>
                        <span class="category_list_button_text">{{ category.name }}</span>
                    </div>
                    {% endfor %}
                </div>
                <input type="hidden" name="category" id="selectedCategory" value="">
            </div>

            <!-- –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç—ã) -->
            <div class="category_list_form_group category_list_hidden" id="subcategoriesGroup">
                <h2 class="category_list_form_label" id="subcategoriesTitle">–®–∞–≥ 2: –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é</h2>
                <div class="category_list_buttons_grid" id="subcategoriesGrid">
                    {% for category in categories %}
                        {% for subcategory in category.appsubcategory_set.all %}
                        <div class="category_list_card category_list_subcategory_card category_list_hidden" 
                             data-category-id="{{ category.id }}"
                             data-subcategory-id="{{ subcategory.id }}">
                            <div class="category_list_button_icon">
                                {% if subcategory.icon %}
                                    <img src="{{ subcategory.icon.url }}" alt="{{ subcategory.name }}">
                                {% else %}
                                    <div class="category_list_icon_placeholder">üéØ</div>
                                {% endif %}
                            </div>
                            <span class="category_list_button_text">{{ subcategory.name }}</span>
                        </div>
                        {% endfor %}
                    {% endfor %}
                </div>
                <input type="hidden" name="subcategory" id="selectedSubcategory" value="">
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
            <div class="category_list_form_group category_list_hidden" id="submitGroup">
                <button type="submit" class="category_list_submit_btn category_list_button_green">
                    –ü–æ–∫–∞–∑–∞—Ç—å –∏–≥—Ä—ã
                    <span class="category_list_btn_sparkle">‚ú®</span>
                </button>
            </div>

        </form>
    </div>
</div>

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const categoriesGrid = document.getElementById('categoriesGrid');
    const subcategoriesGroup = document.getElementById('subcategoriesGroup');
    const subcategoriesGrid = document.getElementById('subcategoriesGrid');
    const subcategoriesTitle = document.getElementById('subcategoriesTitle');
    const submitGroup = document.getElementById('submitGroup');
    const selectedCategoryInput = document.getElementById('selectedCategory');
    const selectedSubcategoryInput = document.getElementById('selectedSubcategory');

    let selectedCategoryId = null;
    let selectedCategoryName = null;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    categoriesGrid.addEventListener('click', function(e) {
        const categoryCard = e.target.closest('.category_list_category_card');
        if (!categoryCard) return;
        
        selectedCategoryId = categoryCard.getAttribute('data-category-id');
        selectedCategoryName = categoryCard.getAttribute('data-category-name');
        
        console.log('Selected category:', selectedCategoryId, selectedCategoryName);
        
        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        selectedCategoryInput.value = selectedCategoryId;
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        showSubcategories(selectedCategoryId, selectedCategoryName);
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    subcategoriesGrid.addEventListener('click', function(e) {
        const subcategoryCard = e.target.closest('.category_list_subcategory_card');
        if (!subcategoryCard) return;
        
        const subcategoryId = subcategoryCard.getAttribute('data-subcategory-id');
        
        console.log('Selected subcategory:', subcategoryId);
        
        // –£–±—Ä–∞—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π
        document.querySelectorAll('.category_list_subcategory_card').forEach(card => {
            card.classList.remove('category_list_selected');
        });
        
        // –í—ã–¥–µ–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é
        subcategoryCard.classList.add('category_list_selected');
        
        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é
        selectedSubcategoryInput.value = subcategoryId;
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
        submitGroup.classList.remove('category_list_hidden');
        
        // –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –∫ –∫–Ω–æ–ø–∫–µ
        submitGroup.scrollIntoView({ 
            behavior: 'smooth',
            block: 'start'
        });
    });

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π
    function showSubcategories(categoryId, categoryName) {
        console.log('Showing subcategories for category:', categoryId);
        
        // –°–∫—Ä—ã—Ç—å –≤—Å–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        document.querySelectorAll('.category_list_subcategory_card').forEach(card => {
            card.classList.add('category_list_hidden');
        });
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        const relevantSubcategories = document.querySelectorAll(
            `.category_list_subcategory_card[data-category-id="${categoryId}"]`
        );
        
        console.log('Found subcategories:', relevantSubcategories.length);
        
        if (relevantSubcategories.length === 0) {
            // –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π, —Å—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
            console.log('No subcategories, submitting form');
            document.getElementById('categoryForm').submit();
            return;
        }
        
        relevantSubcategories.forEach(card => {
            card.classList.remove('category_list_hidden');
        });
        
        // –°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        selectedSubcategoryInput.value = '';
        submitGroup.classList.add('category_list_hidden');
        
        // –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫
        subcategoriesTitle.textContent = `–®–∞–≥ 2: –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é (${categoryName})`;
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –±–ª–æ–∫ —Å –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
        subcategoriesGroup.classList.remove('category_list_hidden');
        
        // –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –∫ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        subcategoriesGroup.scrollIntoView({ 
            behavior: 'smooth',
            block: 'start'
        });
    }

    // –ï—Å–ª–∏ –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è –≤ URL (–ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞–∑–∞–¥)
    const urlParams = new URLSearchParams(window.location.search);
    const urlCategoryId = urlParams.get('category');
    if (urlCategoryId) {
        const categoryCard = document.querySelector(`[data-category-id="${urlCategoryId}"]`);
        if (categoryCard) {
            const categoryName = categoryCard.getAttribute('data-category-name');
            showSubcategories(urlCategoryId, categoryName);
        }
    }
});
</script>
{% endblock %}