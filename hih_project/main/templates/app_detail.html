{% extends 'base.html' %}
{% load static %}

{% block title %}
{{ app.name }} ‚Ä¢ RuStore
{% endblock %}

{% block content %}
<div class="app-page">
    <!-- –ó–ê–ì–û–õ–û–í–û–ö –ü–†–ò–õ–û–ñ–£–•–ò -->
    <div class="app-header">
        <div class="app-icon">
            {% if app.icon %}
                <img src="{{ app.icon.url }}" alt="{{ app.name }}" class="app-icon__img">
            {% else %}
                <div class="app-icon__placeholder">üì±</div>
            {% endif %}
        </div>

        <div class="app-info">
            <h1 class="app-title">{{ app.name }}</h1>

            <a href="{% url 'developer' dev_id=app.developer.id %}" class="app-dev">
                –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫: <span>{{ app.developer.name }}</span>
            </a>

            <div class="app-meta">
                <div class="meta-item">‚≠ê {{ app.rating|floatformat:1 }} <span>({{ app.estimations_count }})</span></div>
                <div class="meta-item">‚¨á {{ app.downloads }}</div>
                <div class="meta-item">üì¶ {{ app.size|filesizeformat }}</div>
            </div>

            <a class="btn-download" href="{{ app_download_link }}" target="_blank">–°–∫–∞—á–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ</a>
        </div>
    </div>

    <div class="app-content">
        <!-- –û–ü–ò–°–¨ -->
        <section class="app-section">
            <h2>–û–ø–∏—Å–∞–Ω–∏–µ</h2>
            <p class="app-desc">{{ app.description }}</p>
        </section>

        <!-- –ö–ê–†–£–°–ï–õ–¨ -->
        {% if app_preview_images %}
            <section class="app-section">
                <h2>–°–∫—Ä–∏–Ω—à–æ—Ç—ã</h2>
                <div class="mini-carousel">
                    <div class="main-image">
                        <img id="mainCarouselImage" src="{{ app_preview_images.0.source.url }}" alt="{{ app.name }}" 
                            onclick="openGallery(0)">
                    </div>

                    <div class="thumbnail-container">
                        {% for image in app_preview_images %}
                            <img src="{{ image.source.url }}" 
                                class="thumbnail {% if forloop.first %}active{% endif %}" 
                                alt="–ú–∏–Ω–∏–∞—Ç—é—Ä–∞ {{ forloop.counter }}"
                                onclick="changeMainImage('{{ image.source.url }}', this); openGallery({{ forloop.counter0 }})">  <!-- –ò–∑–º–µ–Ω–∏ –∑–¥–µ—Å—å -->
                        {% endfor %}
                    </div>
                </div>
            </section>
        {% endif %}

        <!-- –û–í–ï–†–õ–ï–ô –ü–û–õ–ù–û–≠–ö–†–ê–ù–ù–û–ô –ì–ê–õ–ï–†–ï–ò–ò -->
        <div id="galleryOverlay" class="gallery-overlay">
            <div class="gallery-container">
                <button class="gallery-close" onclick="closeGallery()">√ó</button>
                <button class="gallery-nav gallery-prev" onclick="changeGalleryImage(-1)">‚Äπ</button>
                
                <div class="gallery-slide">
                    <img id="galleryImage" src="" alt="–°–∫—Ä–∏–Ω—à–æ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è">
                </div>
                
                <button class="gallery-nav gallery-next" onclick="changeGalleryImage(1)">‚Ä∫</button>
                
                <div class="gallery-counter">
                    <span id="galleryCurrent">1</span> / <span id="galleryTotal">{{ app_preview_images|length }}</span>
                </div>
            </div>
        </div>

        <section class="app-section">
            <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>

            <div class="details-list">
                <div class="detail-item">
                    <span class="detail-label">–ñ–∞–Ω—Ä:</span>
                    <span class="detail-value">{{ app.subcategory.category.name }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">–ü–æ–¥–∂–∞–Ω—Ä:</span>
                    <span class="detail-value">{{ app.subcategory.name }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫:</span>
                    <span class="detail-value">{{ app.developer.name }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">–í–æ–∑—Ä–∞—Å—Ç:</span>
                    <span class="detail-value">{{ app.age_rating.min_age }}+</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">–ü—Ä–æ—Å–º–æ—Ç—Ä—ã:</span>
                    <span class="detail-value">{{ app.views }}</span>
                </div>
            </div>
        </section>

        <section class="review-section">
            <h2 style="color:#544DDF;">–û—Ç–∑—ã–≤—ã</h2>
            {% if user.is_authenticated %}
                <form method="post" class="review-form">
                    {% csrf_token %}
                    <!-- –í–´–ë–û–† –û–¶–ï–ù–ö–ò -->
                    <div class="review-field">
                        <label>–û—Ü–µ–Ω–∫–∞</label>
                         <div class="star-rating">
                            {% for i in "12345" %}
                                <span class="star" data-value="{{ i }}">‚òÖ</span>
                            {% endfor %}
                            <input type="hidden" name="{{ form.estimation.name }}" id="{{ form.estimation.id_for_label }}" value="{% if form.estimation.value %}{{ form.estimation.value }}{% else %}0{% endif %}">
                        </div> 
                        <div class="rating-text">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ü–µ–Ω–∫—É</div>
                    </div>

                    <!-- –°–û–î–ï–†–ñ–ò–ú–û–ï –û–¢–ó–´–í–ê -->
                    <div class="review-field">
                        <label for="{{ form.estimation_content.id_for_label }}">–í–∞—à –æ—Ç–∑—ã–≤</label>
                        {{ form.content }}
                    </div>

                    <!-- –û–¢–ü–†–ê–í–ö–ê –û–¢–ó–´–í–ê -->
                    <button type="submit" class="btn-review">
                        {% if user_estimation_exists %}
                            –ò–∑–º–µ–Ω–∏—Ç—å –æ—Ç–∑—ã–≤
                        {% else %}
                            –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
                        {% endif %}
                    </button>
                </form>
            {% else %}
                <p class="review-login">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</p>
            {% endif %}

            <!-- –°–¢–ê–¢–ê –û–¶–ï–ù–û–ö -->
            <div class="reviews-stats">
            <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ü–µ–Ω–æ–∫</h3>
            <div class="stats-container">
                <div class="stat-row">
                    <span class="stat-star">5 ‚òÖ</span>
                    <div class="stat-bar"><div class="stat-fill" style="width: {% widthratio star_counts.5 estimations|length 100 %}%"></div></div>
                    <span class="stat-count">{{ star_counts.5 }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-star">4 ‚òÖ</span>
                    <div class="stat-bar"><div class="stat-fill" style="width: {% widthratio star_counts.4 estimations|length 100 %}%"></div></div>
                    <span class="stat-count">{{ star_counts.4 }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-star">3 ‚òÖ</span>
                    <div class="stat-bar"><div class="stat-fill" style="width: {% widthratio star_counts.3 estimations|length 100 %}%"></div></div>
                    <span class="stat-count">{{ star_counts.3 }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-star">2 ‚òÖ</span>
                    <div class="stat-bar"><div class="stat-fill" style="width: {% widthratio star_counts.2 estimations|length 100 %}%"></div></div>
                    <span class="stat-count">{{ star_counts.2 }}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-star">1 ‚òÖ</span>
                    <div class="stat-bar"><div class="stat-fill" style="width: {% widthratio star_counts.1 estimations|length 100 %}%"></div></div>
                    <span class="stat-count">{{ star_counts.1 }}</span>
                </div>
            </div>
            <div class="stats-total">
                –í—Å–µ–≥–æ –æ—Ç–∑—ã–≤–æ–≤: <strong>{{ estimations|length }}</strong>
            </div>
           
            <!-- –õ–û–ê–î–ï–† –ü–û–õ–ù–û–¶–ï–ù–ù–´–• –û–¢–ó–´–í–û–í (–æ–Ω–ª–∏ –Ω–µ –ø—É—Å—Ç—ã–µ) -->
            {% for estimation in estimations %}
                {% if estimation.author and estimation.content %}
                    <div class="review">
                        <div class="review-score">‚≠ê {{ estimation.estimation }}</div>
                        <div class="review-author">{{ estimation.author.username }}</div>
                        <div class="review-text">{{ estimation.content }}</div>
                        <div class="review-date">{{ estimation.published_at|date:"d F Y H:i" }}</div>
                    </div>
                {% endif %}
            {% endfor %}
        </section>
    </div>
</div>

<script>
function changeMainImage(src, element) {
    document.getElementById('mainCarouselImage').src = src;
    document.querySelectorAll('.thumbnail').forEach(thumb => {
        thumb.classList.remove('active');
    });
    element.classList.add('active');
}

// –Ω–∞—á–∞–ª–æ –∫–æ–¥–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤

let currentGalleryIndex = 0;
const galleryImages = [
    {% for image in app_preview_images %}
        "{{ image.source.url }}",
    {% endfor %}
];

function openGallery(index) {
    currentGalleryIndex = index;
    updateGalleryImage();
    document.getElementById('galleryOverlay').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeGallery() {
    document.getElementById('galleryOverlay').style.display = 'none';
    document.body.style.overflow = 'auto';
}

function changeGalleryImage(direction) {
    currentGalleryIndex += direction;
    
    if (currentGalleryIndex < 0) {
        currentGalleryIndex = galleryImages.length - 1;
    } else if (currentGalleryIndex >= galleryImages.length) {
        currentGalleryIndex = 0;
    }
    
    updateGalleryImage();
}

function updateGalleryImage() {
    const galleryImage = document.getElementById('galleryImage');
    const galleryCurrent = document.getElementById('galleryCurrent');
    const galleryTotal = document.getElementById('galleryTotal');
    
    galleryImage.src = galleryImages[currentGalleryIndex];
    galleryCurrent.textContent = currentGalleryIndex + 1;
    galleryTotal.textContent = galleryImages.length;
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –≥–∞–ª–µ—Ä–µ–∏ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –æ–≤–µ—Ä–ª–µ–π
document.getElementById('galleryOverlay').addEventListener('click', function(e) {
    if (e.target === this) {
        closeGallery();
    }
});

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
document.addEventListener('keydown', function(e) {
    const gallery = document.getElementById('galleryOverlay');
    if (gallery.style.display === 'flex') {
        if (e.key === 'Escape') closeGallery();
        if (e.key === 'ArrowLeft') changeGalleryImage(-1);
        if (e.key === 'ArrowRight') changeGalleryImage(1);
    }
});

// –ö–æ–Ω–µ—Ü –Ω–æ—á–Ω–æ–≥–æ —Å–∫—Ä–∏–Ω—â–æ—Ç–∞


// –ù–æ—á–Ω–æ–π –∫–æ–¥ –ó–≤–µ–∑–¥—ã
// Star rating functionality
document.addEventListener('DOMContentLoaded', function() {
    const stars = document.querySelectorAll('.star');
    const ratingInput = document.getElementById('{{ form.estimation.id_for_label }}');
    const ratingText = document.querySelector('.rating-text');
    
    // Set initial rating if exists
    const initialRating = parseInt(ratingInput.value);
    if (initialRating > 0) {
        updateStars(initialRating);
        updateRatingText(initialRating);
    }
    
    stars.forEach(star => {
        star.addEventListener('click', function() {
            const value = parseInt(this.getAttribute('data-value'));
            ratingInput.value = value;
            updateStars(value);
            updateRatingText(value);
        });
        
        star.addEventListener('mouseover', function() {
            const value = parseInt(this.getAttribute('data-value'));
            updateStars(value, true);
            updateRatingText(value);
        });
    });
    
    document.querySelector('.star-rating').addEventListener('mouseleave', function() {
        const currentRating = parseInt(ratingInput.value);
        updateStars(currentRating);
        updateRatingText(currentRating);
    });
    
    function updateStars(rating, isHover = false) {
        stars.forEach(star => {
            const starValue = parseInt(star.getAttribute('data-value'));
            if (starValue <= rating) {
                star.classList.add('active');
                if (isHover) {
                    star.classList.add('hover');
                } else {
                    star.classList.remove('hover');
                }
            } else {
                star.classList.remove('active', 'hover');
            }
        });
    }
    
    function updateRatingText(rating) {
        const texts = {
            0: '–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ü–µ–Ω–∫—É',
            1: '–£–∂–∞—Å–Ω–æ',
            2: '–ü–ª–æ—Ö–æ',
            3: '–ù–æ—Ä–º–∞–ª—å–Ω–æ',
            4: '–•–æ—Ä–æ—à–æ',
            5: '–û—Ç–ª–∏—á–Ω–æ'
        };
        ratingText.textContent = texts[rating];
    }
});
</script>

{% endblock %}